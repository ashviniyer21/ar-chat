<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AR Chat Client</title>
    <script type="text/javascript" src="https://unpkg.com/webcam-easy/dist/webcam-easy.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.0"></script>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
</head>
<body>
<br>
<br>

<iframe id = "arframe" src="ar.html" width = "800" height = "600"></iframe>

<video id="webcam" autoplay playsinline width="640" height="480"></video>
<canvas id="canvas" height="480" width="640"></canvas>
<canvas id="dummyCanvas" height="480" width="640"></canvas>
<canvas id="dummyCanvas1" height="480" width="640"></canvas>
<canvas id="dummyCanvas2" height="480" width="640"></canvas>
<label for="roomId">Room ID: </label><input type="text" id="roomId">
<button id="submit" onclick="submitRoom()">Submit</button>
<p id="status"></p>
</body>
<script src="/socket.io/socket.io.js"></script>
<script>
    let first = false;
    let socket = io();
    let roomInput = document.getElementById("roomId");
    let id = -1;
    const webcamElement = document.getElementById('webcam');
    const canvasElement = document.getElementById('canvas');
    canvasElement.style.display = "none";
    const sendImageCanvas = document.getElementById('dummyCanvas');
    const receiveImageCanvas = document.getElementById('dummyCanvas1');
    receiveImageCanvas.style.display = "none";
    const maskImageCanvas = document.getElementById('dummyCanvas2');
    maskImageCanvas.style.display = "none";
    const webcam = new Webcam(webcamElement, 'environment', canvasElement);
    webcam.start();

    var iframe = document.getElementById("arframe")
    var iframeContent = iframe.contentWindow



    loadBodyPix()

    function submitPolynomial(){

    }

    function polynomialFunc(coefficients, x){
        var y = 0
        for(var i = 0; i < coefficients.length; i++){
            y += Math.pow(x, i) * coefficients[i]
            console.log(y)
        }
        return y
    }

    function getModelFromEchoAR(key, file){
        let request = new XMLHttpRequest()
        request.open("GET", "https://console.echoar.xyz/query?key=" + key + "&entry=" + file)
        request.send()
        request.onload = () =>{
            console.log(request)
            if(request.status === 200){
                var response
                response = JSON.parse(request.response)
                var storageId = response['db'][file]['additionalData']['gltfHologramStorageID']
                var url = "https://console.echoAR.xyz/query?key=" + key + "&file=" + storageId

                var polynomialString = response['db'][file]['additionalData']['polynomial'].split(",")
                var polynomial = []
                for(var i = 0; i < polynomialString.length; i++){
                    polynomial.push(parseFloat(polynomialString[i]))
                }

                for(var x = 0; x < 2; x+= 0.1){
                    var point = document.createElement("a-entity")
                    point.setAttribute("position", "" + x + " 0 " + polynomialFunc(polynomial, x) )
                    point.setAttribute("scale", ".01 .01 .01")
                    point.setAttribute("gltf-model", url)
                    iframeContent.document.getElementById("graphMarker").appendChild(point)
                }
            }else{
                console.log("Error")
            }
        }
    }

    let EchoARKey = "yellow-bar-9172"
    let EchoARFile = "239bac05-2d96-433b-871a-13749ed858d8"
    getModelFromEchoAR(EchoARKey, EchoARFile)


    var net
    async function loadBodyPix() {
        net = await bodyPix.load({
            architecture: 'MobileNetV1',
            outputStride: 16,
            multiplier: 0.5,
            quantBytes: 1
        });
    }

    async function segmentImage(){
        try{
            const opacity = 1;
            const flipHorizontal = true;
            const maskBlurAmount = 0

            var img = new Image;
            img.src = receiveImageCanvas.toDataURL("image/png")

            const segmentation = await net.segmentPerson(img, {
                flipHorizontal: true,
                internalResolution: 'low',
                segmentationThreshold: .7
            });

            const coloredPartImage = bodyPix.toMask(segmentation);
            bodyPix.drawMask(
                maskImageCanvas, webcamElement, coloredPartImage, opacity, maskBlurAmount,
                flipHorizontal);

            var ctx = maskImageCanvas.getContext("2d")
            var imgData = ctx.getImageData(0, 0, maskImageCanvas.width, maskImageCanvas.height);
            for(var i = 0; i < imgData.data.length; i+=4){
                if(imgData.data[i] === 0 && imgData.data[i+1] === 0 && imgData.data[i+2] === 0){
                    red = imgData.data[i] = 0;
                    green = imgData.data[i+1] = 0;
                    blue = imgData.data[i+2] = 0;
                    alpha = imgData.data[i+3] = 0;
                }
            }
            ctx.putImageData(imgData, 0, 0);

            iframeContent.document.getElementById('cylinder').setAttribute('src', maskImageCanvas.toDataURL("image/png"))
        }
        catch(e){

        }
    }

    function submitRoom(){
        // console.log("here");
        socket.emit('connection-attempt', roomInput.value);
    }
    socket.on('connection-successful-1', function () {
        first = true;
        document.getElementById('status').innerText = "Waiting for others to join";
    });
    socket.on('connection-successful-2', function (id) {
        document.getElementById('status').innerText = "Others have joined!";
        this.id = id;
        update();
    });
    socket.on('room-full', function () {
        document.getElementById('status').innerText = "Room is full";
    });
    socket.on('image2', function (imageString) {
        if(!first){
            const img = new Image;
            img.onload = () => { receiveImageCanvas.getContext("2d").drawImage(img, 0, 0); };
            img.src = imageString;
            segmentImage()
        }
        update();
    })
    function update() {
        if(first){
            sendImageCanvas.getContext("2d").drawImage(webcamElement, 0, 0);
        }
        var img = sendImageCanvas.toDataURL("imagge/png")

        socket.emit('image', id, sendImageCanvas.toDataURL("image/png"));
    }


</script>
</html>