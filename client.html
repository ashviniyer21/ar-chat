<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AR Chat Client</title>
    <script type="text/javascript" src="https://unpkg.com/webcam-easy/dist/webcam-easy.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.0"></script>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
</head>
<body>
<br>
<br>

<a-scene
        arjs='detectionMode: mono_and_matrix; matrixCodeType:3x3'
        embedded
        renderer="logarithmicDepthBuffer: true;"
        vr-mode-ui="enabled: false"
        gesture-detector
        id="scene">
    <a-marker id = "cameraMarker" type='barcode'  value = '5'>
        <!--        360 / (2 * pi * radius) * image width-->
        <a-cylinder id = "cylinder" height="1" radius="1" src="person1.jpg" open-ended="true" theta-start="50" theta-length="57" position="-1, 1, 0"></a-cylinder>
    </a-marker>

    <a-marker id = "graphMarker" type='barcode'  value = '7'>
        <a-cylinder color="black" height="3" radius=".01" rotation = "0 0 90"></a-cylinder>
        <a-cylinder color="black" height="3" radius=".01" rotation = "0 90 0"></a-cylinder>
        <a-cylinder color="black" height="3" radius=".01" rotation = "90 0 0"></a-cylinder>
    </a-marker>

    <a-entity camera></a-entity>
</a-scene>

<video id="webcam" autoplay playsinline width="640" height="480"></video>
<canvas id="canvas" height="480" width="640"></canvas>
<canvas id="dummyCanvas" height="480" width="640"></canvas>
<label for="roomId">Room ID: </label><input type="text" id="roomId">
<button id="submit" onclick="submitRoom()">Submit</button>
<p id="status"></p>
</body>
<script src="/socket.io/socket.io.js"></script>
<script>
    let first = false;
    let socket = io();
    let roomInput = document.getElementById("roomId");
    let id = -1;
    const webcamElement = document.getElementById('webcam');
    const canvasElement = document.getElementById('canvas');
    canvasElement.style.display = "none";
    const dummyCanvasElement = document.getElementById('dummyCanvas');
    const webcam = new Webcam(webcamElement, 'user', canvasElement);
    webcam.start();
    loadBodyPix()

    var net
    async function loadBodyPix() {
        net = await bodyPix.load({
            architecture: 'MobileNetV1',
            outputStride: 16,
            multiplier: 0.5,
            quantBytes: 1
        });
    }

    async function predict() {
        const opacity = 1;
        const flipHorizontal = true;
        const maskBlurAmount = 0;
        const segmentation = await net.segmentPerson(webcamElement, {
            flipHorizontal: true,
            internalResolution: 'low',
            segmentationThreshold: .7
        });

        const coloredPartImage = bodyPix.toMask(segmentation);
        bodyPix.drawMask(
            dummyCanvasElement, webcamElement, coloredPartImage, opacity, maskBlurAmount,
            flipHorizontal);

        var ctx = dummyCanvasElement.getContext("2d")
        var imgData = ctx.getImageData(0, 0, dummyCanvasElement.width, dummyCanvasElement.height);
        for(var i = 0; i < imgData.data.length; i+=4){
            if(imgData.data[i] === 0 && imgData.data[i+1] === 0 && imgData.data[i+2] === 0){
                red = imgData.data[i] = 0;
                green = imgData.data[i+1] = 0;
                blue = imgData.data[i+2] = 0;
                alpha = imgData.data[i+3] = 0;
            }
        }
        ctx.putImageData(imgData, 0, 0);
    }

    function submitRoom(){
        // console.log("here");
        socket.emit('connection-attempt', roomInput.value);
    }
    socket.on('connection-successful-1', function () {
        first = true;
        document.getElementById('status').innerText = "Waiting for others to join";
    });
    socket.on('connection-successful-2', function (id) {
        document.getElementById('status').innerText = "Others have joined!";
        this.id = id;
        update();
    });
    socket.on('room-full', function () {
        document.getElementById('status').innerText = "Room is full";
    });
    socket.on('image2', function (imageString) {
        if(!first){
            // const img = new Image;
            // console.log("Received");
            // dummyCanvasElement.getContext("2d").clearRect(0, 0, dummyCanvasElement.width, dummyCanvasElement.height)
            // img.onload = () => { dummyCanvasElement.getContext("2d").drawImage(img, 0, 0); };
            // img.src = imageString;
            document.getElementById('cylinder').setAttribute('src', imageString)
        }
        update();
    })
    function update() {
        if(first){
            predict();
        }
        socket.emit('image', id, dummyCanvasElement.toDataURL("image/png"));
        // webcam.snap();
        // console.log("Snap");
    }
</script>
</html>