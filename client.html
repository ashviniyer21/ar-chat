<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AR Chat Client</title>
    <script type="text/javascript" src="https://unpkg.com/webcam-easy/dist/webcam-easy.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.0"></script>
</head>
<body>
<label for="roomId">Room ID: </label><input type="text" id="roomId">
<button id="submit" onclick="submitRoom()">Submit</button>
<p id="status"></p>
<br>
<br>
<div id="myMSE"></div>
<video id="webcam" autoplay playsinline width="640" height="480"></video>
<canvas id="canvas" height="480" width="640"></canvas>
<canvas id="dummyCanvas" height="480" width="640"></canvas>
</body>
<script src="/socket.io/socket.io.js"></script>
<script>
    let first = false;
    let socket = io();
    let roomInput = document.getElementById("roomId");
    let id = -1;
    const webcamElement = document.getElementById('webcam');
    const canvasElement = document.getElementById('canvas');
    canvasElement.style.display = "none";
    const dummyCanvasElement = document.getElementById('dummyCanvas');
    const webcam = new Webcam(webcamElement, 'user', canvasElement);
    loadBodyPix()

    webcam.start()
        .then(result =>{
            // console.log("webcam started");
        })
        .catch(err => {
            console.log(err);
        });

    var net
    async function loadBodyPix() {
        net = await bodyPix.load({
            architecture: 'MobileNetV1',
            outputStride: 16,
            multiplier: 0.75,
            quantBytes: 2
        });
    }

    async function predict() {
        const opacity = 1;
        const flipHorizontal = true;
        const maskBlurAmount = 0;

        const segmentation = await net.segmentPerson(webcamElement,{
            flipHorizontal: true,
            internalResolution: 'full',
            segmentationThreshold: .7
        });

        const coloredPartImage = bodyPix.toMask(segmentation);
        bodyPix.drawMask(
            canvasElement, webcamElement, coloredPartImage, opacity, maskBlurAmount,
            flipHorizontal);
    }

    function submitRoom(){
        // console.log("here");
        socket.emit('connection-attempt', roomInput.value);
    }
    socket.on('connection-successful-1', function () {
        first = true;
        document.getElementById('status').innerText = "Waiting for others to join";
    });
    socket.on('connection-successful-2', function (id) {
        document.getElementById('status').innerText = "Others have joined!";
        this.id = id;
        update();
    });
    socket.on('room-full', function () {
        document.getElementById('status').innerText = "Room is full";
    });
    socket.on('image2', function (imageString) {
        if(!first){
            const img = new Image;
            // console.log("Received");
            img.onload = () => { dummyCanvasElement.getContext("2d").drawImage(img, 0, 0); };
            img.src = imageString;
        }
        update();
    })
    function update() {
        // webcam.snap();
        predict();
        // console.log("Snap");
        socket.emit('image', id, canvasElement.toDataURL());
    }
</script>
</html>