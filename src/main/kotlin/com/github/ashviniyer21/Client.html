<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AR Chat Client</title>
    <script type="text/javascript" src="https://unpkg.com/webcam-easy/dist/webcam-easy.min.js"></script>
</head>
<body>
<label for="roomId">Room ID: </label><input type="text" id="roomId">
<button id="submit" onclick="submitRoom()">Submit</button>
<br>
<br>
<div id="myMSE"></div>
<video id="webcam" autoplay playsinline width="640" height="480"></video>
<canvas id="canvas" class="d-none"></canvas>
<canvas id="dummyCanvas" height="480" width="640"></canvas>
<button onclick="update()">UPDATE</button>
</body>
<p id = "test"></p>
<script>
    let first = false;
    let hasSubmitted = false
    let id = -1;
    let link = "ws://DESKTOP-HF7KRA1.local:8080/entry"
    const roomId = document.getElementById("roomId")
    let socket = new WebSocket(link)
    const webcamElement = document.getElementById('webcam');
    const canvasElement = document.getElementById('canvas');
    canvasElement.style.display = "none";
    const dummyCanvasElement = document.getElementById('dummyCanvas');
    const webcam = new Webcam(webcamElement, 'user', canvasElement);

    function submitRoom(){
        if(!hasSubmitted){
            socket.send(roomId.value)
        }
        hasSubmitted = true;
    }
    socket.onmessage = function (event) {
        if((event.data.charAt(0) === '1' && !first || (event.data.charAt(0) === '2' && first))){
                const img = new Image;
                img.onload = () => { dummyCanvasElement.getContext("2d").drawImage(img, 0, 0); };
                img.src = event.data.substring(2);
                update();
        } else if(event.data !== "Full"){
            id = roomId.value;
            let data = event.data.split("|")
            if(data.length > 1){
                console.log(data[1])
                console.log(roomId.value)
                if(data[0] === "Second" && data[1] === roomId.value){
                    webcam.start()
                        .then(result =>{
                            console.log("webcam started");
                        })
                        .catch(err => {
                            console.log(err);
                        });
                }
            } else {
                if(data[0] === "First"){
                    first = true;
                } else {
                    data = data[0].split(":")
                    console.log(data[1]);
                }
            }
        }
    };
    function update() {
        let picture = webcam.snap();
        console.log(canvasElement.toDataURL())
        if(first){
            socket.send("1|" + canvasElement.toDataURL())
        } else {
            socket.send("2|" + canvasElement.toDataURL())
        }
    }
</script>
</html>